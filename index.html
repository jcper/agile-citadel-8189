<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
</head>
<body>
 <div class="col-sm-12">
      <div class="well">
        <h2>SISTEMA INTEGRADO ALARMAS 24(SIA24)</h2>

    <p id='server-time'></p>
     <script>
    
      var HOST = location.origin.replace(/^http/, 'ws');
      var ws = new WebSocket(HOST);
      var server=document.getElementById('server-time');
      var indice=1;
      var indiceTB=1;
      var indiceN=1;
      var usuarios=[];
      var creado=false;
      var miregistro=1;
      var nopintarN=false;
      var comandoRecRestaurar=false;
      var comandoRecDesactivar=false;
      var comandoRecBuscar=false; 
      var comandoRecNotificar=false;
      var desconexiones_elec=0;
      var Ethernet=0;
      ws.onmessage = function (event) {
   
      var table = document.getElementById('myTable');
        var message = JSON.parse(event.data);
        if(message.name!==undefined || message.alarmasC!==undefined ){

      
        if(message.alarmasC!==undefined){//esto para no crear usuario de la notificacion
        var  usuario={
            name: message.name,
            registro: indice,
            alarma:message.alarmasC,
            desconexiones:desconexiones_elec,
            ethernet:Ethernet
         };
       }; 
       
       //Devuelve inicioConexion al cliente.
        if(message.conexion>=0){
          alert('prueba1'+ message.conexion);
           for (var i=0; i<usuarios.length; i++){ 
             alert('prueba'+ message.conexion);
             if(message.name===usuarios[i].name){
               usuarios[i].desconexiones++;
               alert('desconexiones' + usuarios[i].desconexiones);
               var usuariod=message.user;
               var conexion={};
               conexion.comando='conectado';
               conexion.user = usuariod;
               conexion.contador=usuarios[i].desconexiones;
              ws.send(JSON.stringify(conexion));
             }
           }
         }

         if(message.ErrorEthernet>=0){
          for (var i=0; i<usuarios.length; i++){
            if(message.name===usuarios[i].name){
              usuarios[i].ethernet++;
             alert('ethernet' + usuarios[i].ethernet);
           var usuarioE=message.user;
           var ErrorEthernet={};
         ErrorEthernet.comando='ErrorEthernet';
         ErrorEthernet.user = usuarioE;
         ErrorEthernet.contador= usuarios[i].ethernet;
         ws.send(JSON.stringify(ErrorEthernet)); 
          }
        }
      }
       



       if(message.comando==='notificar0' || message.comando==='buscar' || message.comando==='restaurar' || message.comando==='desactivar') {
       if(message.comando==='notificar0'){
           var comandoRecNotificar=true; 
       };
        if(message.comando==='buscar'){
           var comandoRecBuscar=true; 
       }

        if(message.comando==='restaurar'){
           var comandoRecRestaurar=true; 
       }

        if(message.comando==='desactivar'){
           var comandoRecDesactivar=true; 
       }

        var table2=document.getElementById('myTable2');
         if(indiceN==1){
        var row = table2.insertRow(1);
        var cell1 = row.insertCell(0);
        var cell2 = row.insertCell(1);
        var cell3 = row.insertCell(2);
        var cell4 = row.insertCell(3);
        cell1.innerHTML = message.name;
        cell2.innerHTML = message.comando;
        cell3.innerHTML = message.date;
        cell4.innerHTML = message.ip;
        indiceN++;
     
       }else{
         var row = table2.insertRow(indiceN);  
        var cell1 = row.insertCell(0);
        var cell2 = row.insertCell(1);
        var cell3 = row.insertCell(2);
        var cell4 = row.insertCell(3);
        cell1.innerHTML = message.name;
        cell2.innerHTML = message.comando;
        cell3.innerHTML = message.date;
        cell4.innerHTML = message.ip;
        indiceN++;
       };
        nopintarN=true;//Esto booleano no escribe la notificacion en los equipos en curso.

     };
    
      //if (indice!==1){
        for (var i=0; i<usuarios.length; i++){
             var usuarioAct=usuarios[i];
            
          if(message.name===usuarioAct.name){
             creado=true;
             miregistro=usuarioAct.registro;
             usuarioAct.alarma=message.alarmasC;
            
          };
        };
       
        if(!nopintarN){
        if(creado){
        if(message.name !==undefined || message.alarma !==undefined || message.date!==undefined || message.ip !==undefined || message.comando!==undefined){
         document.getElementById("myTable").deleteRow(miregistro);
        var row =  table.insertRow(miregistro);
        var cell1 = row.insertCell(0);
        var cell2 = row.insertCell(1);
        var cell3 = row.insertCell(2);
        var cell4 = row.insertCell(3);
        cell1.innerHTML = message.name;
        cell2.innerHTML = message.alarmasC[0]+','+message.alarmasC[1]+','+message.alarmasC[2];
        cell3.innerHTML = message.date;
        cell4.innerHTML = message.ip;
        creado=false;
        indice++;
        };
          }else{
        if(message.name !==undefined || message.alarma !==undefined || message.date!==undefined || message.ip!==undefined ||message.comando!==undefined){
        usuarios.push(usuario);
        indice++;
        var row = table.insertRow(indiceTB);
        var cell1 = row.insertCell(0);
        var cell2 = row.insertCell(1);
        var cell3 = row.insertCell(2);
        var cell4 = row.insertCell(3);
        cell1.innerHTML = message.name;
        cell2.innerHTML = message.alarmasC[0]+','+message.alarmasC[1]+','+message.alarmasC[2];
        cell3.innerHTML = message.date;
        cell4.innerHTML = message.ip;
        indiceTB++;
             };
          };
        };
      };
        nopintarN=false;

      };

    

      function sendMessageRestaurar() {
        var comando1={};
         comando1.comando='restaurar';
         comando1.user = document.getElementById("restaurar").value;
        ws.send(JSON.stringify(comando1));
         var tiempoComandoR=new Date();
         var d_restaurar=tiempoComandoR.getTime()+60000;
         var contadorR=0;
         while(contadorR<3){
          var timeoutR=new Date();
          var TimeoutR=timeoutR.getTime();
          if(TimeoutR<d_restaurar){
          if(comandoRecRestaurar){
         document.getElementById("restaurar").value = "";//Se limpia el buffer 
         contadorR=3;
           comandoRecRestaurar=false;
            }else{
           document.getElementById("restaurar").value = 'wait';
             ws.send(JSON.stringify(comando1));
           contadorR++;
          }
         }else{
             document.getElementById("restaurar").value = 'timeout';
              comandoRecRestaurar=false;
         }
        }
         document.getElementById("restaurar").value = "";
          comandoRecRestaurar=false;
        }

      
    
      function sendMessageNotificar() {
        var comando2={};
        comando2.comando='notificar';
        comando2.user = document.getElementById("notificar").value;
        ws.send(JSON.stringify(comando2));
         var tiempoComandoN=new Date();
         var d_notificar=tiempoComandoN.getTime()+60000;
         var contadorN=0;
         while(contadorN<3){
          var timeoutN=new Date();
          var TimeoutN=timeoutN.getTime();
          if(TimeoutN<d_notificar){
          if(comandoRecNotificar){
         document.getElementById("notificar").value = "";//Se limpia el buffer 
         contadorN=3;
           comandoRecNotificar=false;
            }else{
           document.getElementById("notificar").value = 'wait';
             ws.send(JSON.stringify(comando2));
           contadorN++;
          }
         }else{
             document.getElementById("notificar").value = 'timeout';
              comandoRecNotificar=false;
         }
        }
         document.getElementById("notificar").value = "";
          comandoRecNotificar=false;
      }


       function sendMessageDesactivacion() {
        var comando4={};
        comando4.comando='desactivar';
        comando4.user = document.getElementById("notificar").value;
        ws.send(JSON.stringify(comando4));
        var tiempoComando=new Date();
        var d_desactivar=tiempoComando.getTime()+60000;
        var contador=0;
        while(contador<3){
          var timeoutD=new Date();
          var TimeoutD=timeoutD.getTime();
          if(TimeoutD<d_desactivar){
          if(comandoRecDesactivar){
         document.getElementById("notificar").value = "";//Se limpia el buffer 
         contador=3;
           comandoRecDesactivar=false;
            }else{
           document.getElementById("notificar").value = 'wait';
             ws.send(JSON.stringify(comando4));
           contador++;
          }
         }else{
             document.getElementById("notificar").value = 'timeout';
              comandoRecDesactivar=false;
         }
        }
         document.getElementById("notificar").value = "";
          comandoRecDesactivar=false;
        }

      

        function sendMessageBuscar() {
        var comando3 ={};
        comando3.comando='buscar';
        comando3.user = document.getElementById("buscar").value;
        ws.send(JSON.stringify(comando3));
        var tiempoComandoB=new Date();
        var d=tiempoComandoB.getTime()+60000;
        var contadorB=0;
         while(contadorB<3){
          var timeout=new Date();
          var Timeout=timeout.getTime();
        if(Timeout<d ){
          if(comandoRecBuscar){
         document.getElementById("buscar").value = "";//Se limpia el buffer 
         contadorB=3;
           comandoRecBuscar=false;
            }else{
           document.getElementById("buscar").value = 'wait';
             ws.send(JSON.stringify(comando3));
             contadorB++;
          }
         }else{
             document.getElementById("buscar").value = 'timeout';
              comandoRecBuscar=false;
         }
        }
         document.getElementById("buscar").value = "";
          comandoRecBuscar=false;
      }



    </script> 
  </div>

 <div class="col-sm-4">
  <form class="form-inline">
  <div class="form-group">
  <input type="text" class="form-control" id="buscar" placeholder="Introduce nombre equipo">
   <button type="button" class="btn btn-success" onclick="sendMessageBuscar()">buscar</button>
   </div> 
  </div> 

 <div class="col-sm-4">
 <input type="text" class="form-control" id="restaurar" placeholder="Introduce nombre equipo">
  &nbsp
 <button type="button" class="btn btn-warning" onclick="sendMessageRestaurar()">Restaurar</button>
 </div> 

<div class="col-sm-4">
  <input type="text" class="form-control" id="notificar" placeholder="Introduce nombre equipo">
   &nbsp
   <button type="button" class="btn btn-warning" onclick="sendMessageNotificar()">Notificar</button>
   &nbsp &nbsp &nbsp &nbsp
   <button type="button" class="btn btn-danger" onclick="sendMessageDesactivacion()">Desactivar</button>
 </div>
<div class="col-sm-4" id='TablaEquipos'>
  <h3>Equipos en curso</h3>         
  <table class="table table-bordered" id='myTable'>
    <thead>
      <tr>
        <th>Equipo</th>
        <th>Alarmas</th>
        <th>Inicio Conexion</th>
        <th>Ubicacion</th>
      </tr>
    </thead>
    </table>
   
</div>
<div class="col-sm-5" id='TiposAlarma'>
  <h3>Tipos De Alarma</h3>         
  <table class="table table-bordered" id='myTable3'>
    <thead>
      <tr>
        <th>Tipo</th>
        <th>Nivel</th>
        <th>Optimo</th>
        </tr>
    </thead
     <tbody>
      <tr>
        <td>Alarma 0</td>
        <td>Sin alarma, Agora activo</td>
        <td>Ram Libre +1gb/Cpu Load <80%</td>
      </tr>
      <tr>
        <td>Alarma 1</td>
        <td>CPU 80%</td>
        <td>CPU 50%</td>
      </tr>
      <tr>
        <td>Alarma 2</td>
        <td>Ram Libre 1gb</td>
        <td>Ram Libre 1,5gb</td>
      </tr>
       <tr>
        <td>Alarma 3</td>
        <td>Ram Libre -1gb/Cpu Load -80%</td>
        <td>Alarma 1 y 2 activadas</td>
      </tr>
      <tr>
        <td>Alarma 4</td>
        <td>Servicio Agora</td>
        <td>Alarma 0</td>
      </tr>
       <tr>
        <td>Alarma 5</td>
        <td>Desconexion electrica</td>
        <td>2 desconexiones</td>
      </tr>
      <tr>
        <td>Alarma 6</td>
        <td>Desconexion ethernet</td>
        <td>10 desconexiones</td>
      </tr>
    </tbody>
    </table>
</div>
<div class="col-sm-3">
  <h3>Notificaciones</h3>         
  <table class="table table-bordered" id='myTable2'>
    <thead>
      <tr>
        <th>Equipo</th>
        <th>Notificacion</th>
        <th>Fecha</th>
        <th>Ubicacion</th>
      </tr>
    </thead>
    </table>
   
</div>

</body>
</html>
